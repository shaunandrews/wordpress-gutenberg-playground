/**
 * External dependencies
 */
import { FORMAT_ID } from '@terrazzo/plugin-css';
import type { Plugin } from '@terrazzo/parser';

export default function pluginKnownWpdsCssVariables( {
	filename = 'design-tokens.js',
} = {} ): Plugin {
	return {
		name: '@terrazzo/plugin-known-wpds-css-variables',
		async build( { getTransforms, outputFile } ) {
			// Either a string (modes=false) or an object (modes=true)
			const tokensToExport: Record<
				string,
				Record< string, string | Record< string, string > >
			> = {};

			for ( const token of getTransforms( {
				format: FORMAT_ID,
				id: '*',
			} ) ) {
				if ( ! token.localID ) {
					console.warn(
						'Unexpected â€” Missing local ID when building token list for eslint plugin'
					);
					continue;
				}

				tokensToExport[ token.localID ] ??= {};
				tokensToExport[ token.localID ][ token.mode ] = token.value;
			}

			outputFile(
				filename,
				[
					'/**',
					' * This file is generated by the @terrazzo/plugin-known-wpds-css-variables plugin.',
					' * Do not edit this file directly.',
					' */',
					'',
					`export default ${ JSON.stringify(
						Array.from( new Set( Object.keys( tokensToExport ) ) ),
						null,
						2
					) }`,
					'', // final empty line
				].join( '\n' )
			);
		},
	};
}
