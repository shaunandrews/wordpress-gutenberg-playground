/**
 * External dependencies
 */
import { type Plugin, type TokenNormalized } from '@terrazzo/parser';

interface InlineAliasValuesOptions {
	/**
	 * Output filename for the generated aliased tokens mapping.
	 */
	filename?: string;

	/**
	 * Pattern matching IDs of tokens whose values should be inlined into their alias references.
	 */
	pattern: RegExp;

	/**
	 * Optional function to transform token IDs in the output.
	 */
	tokenId?: ( tokenId: string ) => string;
}

/**
 * Inlines the values of tokens matching the given pattern into their alias
 * references. Matching tokens are removed from the output, and a TypeScript
 * file is emitted with the mapping of aliased tokens.
 *
 * @param options          The options for the plugin.
 * @param options.filename
 * @param options.pattern
 * @param options.tokenId
 */
export default function inlineAliasValues( {
	filename,
	pattern,
	tokenId = ( id ) => id,
}: InlineAliasValuesOptions ): Plugin {
	const aliasedBy: Record< string, string[] > = {};

	return {
		name: '@wordpress/terrazzo-plugin-inline-alias-values',
		async transform( { tokens } ) {
			// Map of primitive token ID -> array of references to inline
			const inlineMap: Record< string, TokenNormalized[] > = {};

			// Single pass: identify primitives and collect references
			for ( const [ id, token ] of Object.entries( tokens ) ) {
				const shouldInline = pattern.test( id );

				if ( shouldInline ) {
					// Track this token for inlining
					inlineMap[ id ] = [];

					// Track aliased tokens for output file
					if ( token.aliasedBy ) {
						aliasedBy[ tokenId( id ) ] =
							token.aliasedBy.map( tokenId );
					}
				}

				// Check if this token's main value references a primitive
				if ( token.aliasOf && pattern.test( token.aliasOf ) ) {
					inlineMap[ token.aliasOf ] ??= [];
					inlineMap[ token.aliasOf ].push( token );
				}

				// Check if any mode values reference a primitive
				for ( const modeValue of Object.values( token.mode ) ) {
					const { aliasOf } = modeValue;
					if ( aliasOf && pattern.test( aliasOf ) ) {
						const primitiveId = aliasOf;
						inlineMap[ primitiveId ] ??= [];
						inlineMap[ primitiveId ].push( modeValue );
					}
				}
			}

			// Inline values and delete primitives
			for ( const [ id, references ] of Object.entries( inlineMap ) ) {
				const token = tokens[ id ];

				for ( const target of references ) {
					target.$value = token.$value;
					target.originalValue = token.originalValue;
					delete target.aliasOf;
					delete target.aliasChain;
				}

				delete tokens[ id ];
			}
		},
		async build( { outputFile } ) {
			if ( ! filename ) {
				return;
			}

			const json = JSON.stringify( aliasedBy, null, 2 );

			outputFile(
				filename,
				[
					'/**',
					' * This file is generated by the @wordpress/terrazzo-plugin-inline-alias-values plugin.',
					' * Do not edit this file directly.',
					' */',
					'',
					`export default ${ json } as Record< string, string[] >;`,
					'',
				].join( '\n' )
			);
		},
	};
}
